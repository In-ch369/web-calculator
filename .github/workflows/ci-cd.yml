name: Web Calculator

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  GITHUB_USERNAME: ${{ github.repository_owner }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run unit tests with pytest
      run: |
        python -m pytest tests/unit_tests/ -v --junitxml=junit-unit-${{ matrix.python-version }}.xml --cov=calculator --cov-report=xml
    
    - name: Run functional tests
      run: |
        # å¯åŠ¨åº”ç”¨
        python app.py &
        APP_PID=$!
        
        # ç­‰å¾…åº”ç”¨å¯åŠ¨
        sleep 10
        
        # è¿è¡ŒåŠŸèƒ½æµ‹è¯•
        python -m pytest tests/functional_tests/ -v --junitxml=junit-func-${{ matrix.python-version }}.xml
        
        # åœæ­¢åº”ç”¨
        kill $APP_PID
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.python-version }}
        path: |
          junit-*.xml
          coverage.xml
        retention-days: 7

  build:
    name: Build and Push Docker Image
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || startsWith(github.ref, 'refs/tags/'))
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.CR_PAT }}
    
    - name: Generate short SHA
      id: sha
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
        echo "sha=$SHORT_SHA" >> $GITHUB_OUTPUT
    
    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=raw,value=sha-${{ env.SHORT_SHA }}
          type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
          type=ref,event=branch
          type=ref,event=tag
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          GIT_COMMIT=${{ github.sha }}
    
    - name: Output image info
      run: |
        echo "é•œåƒæ ‡ç­¾: ${{ steps.meta.outputs.tags }}"
        echo "å®Œæ•´é•œåƒå: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ env.SHORT_SHA }}"

  deploy:
    name: Blue-Green Deployment
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: production
      url: http://${{ secrets.VM_HOST }}
    
    steps:
    - name: Install sshpass
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
    
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Get build info
      id: build-info
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "DEPLOY_TAG=sha-$SHORT_SHA" >> $GITHUB_ENV
        echo "IMAGE_FULL=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-$SHORT_SHA" >> $GITHUB_ENV
        echo "SHORT_SHA=$SHORT_SHA" >> $GITHUB_ENV
    
    # æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
    - name: Check if image exists
      env:
        GHCR_TOKEN: ${{ secrets.CR_PAT }}
      run: |
        echo "æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨..."
        echo "é•œåƒåœ°å€: ${{ env.IMAGE_FULL }}"
        
        # ä½¿ç”¨ Docker Manifest æ£€æŸ¥é•œåƒæ˜¯å¦å­˜åœ¨
        if docker manifest inspect "${{ env.IMAGE_FULL }}" > /dev/null 2>&1; then
          echo "âœ… é•œåƒå­˜åœ¨"
        else
          echo "âŒ é•œåƒä¸å­˜åœ¨ï¼Œç­‰å¾… 30 ç§’åé‡è¯•..."
          sleep 30
          
          if docker manifest inspect "${{ env.IMAGE_FULL }}" > /dev/null 2>&1; then
            echo "âœ… é•œåƒç°åœ¨å­˜åœ¨äº†"
          else
            echo "âŒ é•œåƒä»ç„¶ä¸å­˜åœ¨ï¼Œåˆ—å‡ºå¯ç”¨é•œåƒ..."
            
            # è·å–ä»“åº“ä¸­çš„æ‰€æœ‰æ ‡ç­¾
            curl -s -H "Authorization: Bearer ${{ secrets.CR_PAT }}" \
              "https://ghcr.io/v2/${{ github.repository }}/tags/list" | jq .
            
            # åˆ—å‡ºæœ€è¿‘çš„é•œåƒ
            echo "æœ€è¿‘æ„å»ºçš„é•œåƒï¼š"
            gh api /orgs/${{ github.repository_owner }}/packages/container/${{ github.event.repository.name }}/versions \
              --jq '.[] | "\(.id) - \(.metadata.container.tags)"'
              
            exit 1
          fi
        fi
    
    - name: Prepare deployment script
      run: |
        cat > /tmp/deploy_final.sh << 'DEPLOY_SCRIPT'
        #!/bin/bash
        set -e
        
        echo "=== éƒ¨ç½²å¼€å§‹ ==="
        echo "æ—¶é—´: $(date)"
        echo "é•œåƒ: $IMAGE_FULL"
        echo "æ ‡ç­¾: $DEPLOY_TAG"
        echo "çŸ­SHA: $SHORT_SHA"
        
        # 1. åˆ—å‡ºæ‰€æœ‰å¯ç”¨é•œåƒï¼ˆè°ƒè¯•ç”¨ï¼‰
        echo ""
        echo "=== æ­¥éª¤1: æ£€æŸ¥æœ¬åœ°é•œåƒ ==="
        docker images | grep web-calculator || echo "æ— æœ¬åœ°é•œåƒ"
        
        # 2. ç™»å½•åˆ° GitHub Container Registry
        echo ""
        echo "=== æ­¥éª¤2: ç™»å½•åˆ° ghcr.io ==="
        
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§è®¤è¯
        rm -f ~/.docker/config.json 2>/dev/null || true
        
        if [ -n "$GHCR_TOKEN" ] && [ -n "$GITHUB_USERNAME" ]; then
            echo "ä½¿ç”¨ Token ç™»å½•..."
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
            
            if [ $? -ne 0 ]; then
                echo "âŒ ç™»å½•å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•"
                docker logout ghcr.io 2>/dev/null || true
                sleep 2
                echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GITHUB_USERNAME" --password-stdin
            fi
        else
            echo "âŒ ç¼ºå°‘è®¤è¯ä¿¡æ¯"
            exit 1
        fi
        
        echo "âœ… ç™»å½•æˆåŠŸ"
        
        # 3. åˆ—å‡ºä»“åº“ä¸­çš„å¯ç”¨æ ‡ç­¾
        echo ""
        echo "=== æ­¥éª¤3: æ£€æŸ¥ä»“åº“ä¸­çš„é•œåƒæ ‡ç­¾ ==="
        echo "æ­£åœ¨æŸ¥è¯¢å¯ç”¨æ ‡ç­¾..."
        
        # å°è¯•è·å–å¯ç”¨æ ‡ç­¾
        TAGS_RESPONSE=$(curl -s -H "Authorization: Bearer $GHCR_TOKEN" \
          "https://ghcr.io/v2/$REPO_OWNER/$REPO_NAME/tags/list" 2>/dev/null || echo "{}")
        
        if echo "$TAGS_RESPONSE" | grep -q "tags"; then
            echo "å¯ç”¨æ ‡ç­¾:"
            echo "$TAGS_RESPONSE" | jq -r '.tags[]' | head -20
            
            # æ£€æŸ¥æˆ‘ä»¬çš„æ ‡ç­¾æ˜¯å¦å­˜åœ¨
            if echo "$TAGS_RESPONSE" | grep -q "$DEPLOY_TAG"; then
                echo "âœ… æ‰¾åˆ°ç›®æ ‡æ ‡ç­¾: $DEPLOY_TAG"
            else
                echo "âŒ æœªæ‰¾åˆ°æ ‡ç­¾: $DEPLOY_TAG"
                echo "å°è¯•æŸ¥æ‰¾åŒ…å« $SHORT_SHA çš„æ ‡ç­¾..."
                
                # æŸ¥æ‰¾åŒ…å«çŸ­SHAçš„æ ‡ç­¾
                MATCHING_TAGS=$(echo "$TAGS_RESPONSE" | jq -r ".tags[] | select(contains(\"$SHORT_SHA\"))")
                if [ -n "$MATCHING_TAGS" ]; then
                    echo "æ‰¾åˆ°ç›¸ä¼¼æ ‡ç­¾:"
                    echo "$MATCHING_TAGS"
                    echo "ä½¿ç”¨ç¬¬ä¸€ä¸ªåŒ¹é…çš„æ ‡ç­¾..."
                    ALT_TAG=$(echo "$MATCHING_TAGS" | head -1)
                    echo "æ”¹ç”¨æ ‡ç­¾: $ALT_TAG"
                    DEPLOY_TAG="$ALT_TAG"
                    IMAGE_FULL="ghcr.io/$REPO_OWNER/$REPO_NAME:$ALT_TAG"
                else
                    echo "å°è¯•æ‹‰å– latest æ ‡ç­¾..."
                    DEPLOY_TAG="latest"
                    IMAGE_FULL="ghcr.io/$REPO_OWNER/$REPO_NAME:latest"
                fi
            fi
        else
            echo "âš ï¸ æ— æ³•è·å–æ ‡ç­¾åˆ—è¡¨ï¼Œç»§ç»­å°è¯•æ‹‰å–"
        fi
        
        # 4. æ‹‰å–é•œåƒ
        echo ""
        echo "=== æ­¥éª¤4: æ‹‰å–é•œåƒ ==="
        echo "æ‹‰å–: $IMAGE_FULL"
        
        # å°è¯•æ‹‰å–ï¼Œæœ€å¤šé‡è¯•3æ¬¡
        for i in {1..3}; do
            echo "å°è¯• $i/3..."
            if docker pull "$IMAGE_FULL"; then
                echo "âœ… é•œåƒæ‹‰å–æˆåŠŸ"
                break
            else
                if [ $i -eq 3 ]; then
                    echo "âŒ é•œåƒæ‹‰å–å¤±è´¥"
                    
                    # å°è¯•æ‹‰å–å…¶ä»–å¯èƒ½çš„æ ‡ç­¾
                    echo "å°è¯•æ‹‰å– latest æ ‡ç­¾..."
                    docker pull "ghcr.io/$REPO_OWNER/$REPO_NAME:latest" && {
                        echo "âœ… æˆåŠŸæ‹‰å– latest æ ‡ç­¾"
                        DEPLOY_TAG="latest"
                        IMAGE_FULL="ghcr.io/$REPO_OWNER/$REPO_NAME:latest"
                    } || {
                        echo "âŒ æ‰€æœ‰æ‹‰å–å°è¯•éƒ½å¤±è´¥"
                        exit 1
                    }
                fi
                echo "ç­‰å¾… 5 ç§’åé‡è¯•..."
                sleep 5
            fi
        done
        
        # 5. éªŒè¯æ‹‰å–çš„é•œåƒ
        echo ""
        echo "=== æ­¥éª¤5: éªŒè¯é•œåƒ ==="
        docker images | grep "$REPO_NAME" | head -5
        
        # 6. è¿›å…¥é¡¹ç›®ç›®å½•
        echo ""
        echo "=== æ­¥éª¤6: è¿›å…¥é¡¹ç›®ç›®å½• ==="
        cd /opt/web-calculator
        
        # 7. è“è‰²ç»¿è‰²éƒ¨ç½²é€»è¾‘
        echo ""
        echo "=== æ­¥éª¤7: æ‰§è¡Œè“è‰²ç»¿è‰²éƒ¨ç½² ==="
        
        # ç¡®å®šå½“å‰æ´»è·ƒé¢œè‰²
        if docker ps --format "table {{.Names}}" | grep -q "app_blue" && \
          grep -q "app_blue.*max_fails" nginx/conf.d/default.conf 2>/dev/null; then
            CURRENT="blue"
            NEXT="green"
        else
            CURRENT="green"
            NEXT="blue"
        fi
        
        echo "å½“å‰æ´»è·ƒ: $CURRENT"
        echo "éƒ¨ç½²åˆ°: $NEXT"
        
        # 8. æ›´æ–°ç¯å¢ƒå˜é‡
        echo ""
        echo "=== æ­¥éª¤8: æ›´æ–°ç¯å¢ƒå˜é‡ ==="
        if [ "$NEXT" = "blue" ]; then
            cat > .env << EOF
        BLUE_TAG=$DEPLOY_TAG
        GREEN_TAG=latest
        DEPLOY_TAG=$DEPLOY_TAG
        GITHUB_USERNAME=$GITHUB_USERNAME
        EOF
        else
            cat > .env << EOF
        BLUE_TAG=latest
        GREEN_TAG=$DEPLOY_TAG
        DEPLOY_TAG=$DEPLOY_TAG
        GITHUB_USERNAME=$GITHUB_USERNAME
        EOF
        fi
        
        echo "ç¯å¢ƒå˜é‡:"
        cat .env
        
        # 9. æ‹‰å–æŒ‡å®šæœåŠ¡çš„é•œåƒ
        echo ""
        echo "=== æ­¥éª¤9: æ‹‰å–æ–°ç‰ˆæœ¬ ==="
        docker-compose pull "app_$NEXT"
        
        # 10. å¯åŠ¨æ–°æœåŠ¡
        echo ""
        echo "=== æ­¥éª¤10: å¯åŠ¨æ–°æœåŠ¡ ==="
        docker-compose up -d "app_$NEXT"
        
        # 11. å¥åº·æ£€æŸ¥
        echo ""
        echo "=== æ­¥éª¤11: å¥åº·æ£€æŸ¥ ==="
        for i in {1..30}; do
            if docker-compose ps "app_$NEXT" 2>/dev/null | grep -q "(healthy)"; then
                echo "âœ… å®¹å™¨å¥åº·"
                break
            fi
            
            if [ $i -eq 30 ]; then
                echo "âŒ å¥åº·æ£€æŸ¥è¶…æ—¶"
                docker-compose logs "app_$NEXT" --tail=50
                exit 1
            fi
            
            echo "ç­‰å¾…å¥åº·æ£€æŸ¥... ($i/30)"
            sleep 2
        done
        
        # 12. æ›´æ–° Nginx é…ç½®
        echo ""
        echo "=== æ­¥éª¤12: æ›´æ–° Nginx é…ç½® ==="
        # ç§»é™¤æ‰€æœ‰ max_fails é…ç½®
        sed -i 's/ max_fails=[0-9]\+ fail_timeout=[0-9]\+s//g' nginx/conf.d/default.conf
        # ä¸ºæ–°çš„æ´»è·ƒç‰ˆæœ¬æ·»åŠ é…ç½®
        sed -i "s|server app_$NEXT:5000;|server app_$NEXT:5000 max_fails=1 fail_timeout=5s;|" nginx/conf.d/default.conf
        
        echo "æ›´æ–°åçš„ Nginx é…ç½®:"
        grep "server app_" nginx/conf.d/default.conf
        
        # 13. é‡æ–°åŠ è½½ Nginx
        echo ""
        echo "=== æ­¥éª¤13: é‡æ–°åŠ è½½ Nginx ==="
        docker-compose exec -T proxy nginx -s reload
        
        # 14. åœæ­¢æ—§å®¹å™¨
        echo ""
        echo "=== æ­¥éª¤14: åœæ­¢æ—§å®¹å™¨ ==="
        docker-compose stop "app_$CURRENT"
        
        # 15. éªŒè¯éƒ¨ç½²
        echo ""
        echo "=== æ­¥éª¤15: éªŒè¯éƒ¨ç½² ==="
        sleep 3
        
        echo "æµ‹è¯•å¥åº·ç«¯ç‚¹..."
        if curl -f -s -o /dev/null -w "%{http_code}" http://localhost/health | grep -q "200"; then
            echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸ"
            echo ""
            echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
            echo "æ´»è·ƒç‰ˆæœ¬: $NEXT"
            echo "é•œåƒç‰ˆæœ¬: $DEPLOY_TAG"
            echo "é•œåƒ: $IMAGE_FULL"
        else
            echo "âŒ éƒ¨ç½²éªŒè¯å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š"
            
            # å›æ»šï¼šå¯åŠ¨æ—§ç‰ˆæœ¬
            docker-compose start "app_$CURRENT"
            # æ¢å¤ Nginx é…ç½®
            sed -i 's/ max_fails=[0-9]\+ fail_timeout=[0-9]\+s//g' nginx/conf.d/default.conf
            sed -i "s|server app_$CURRENT:5000;|server app_$CURRENT:5000 max_fails=1 fail_timeout=5s;|" nginx/conf.d/default.conf
            docker-compose exec -T proxy nginx -s reload
            
            echo "âœ… å·²å›æ»šåˆ° $CURRENT ç‰ˆæœ¬"
            exit 1
        fi
        
        # 16. æ¸…ç†æ—§é•œåƒ
        echo ""
        echo "=== æ­¥éª¤16: æ¸…ç†èµ„æº ==="
        echo "æ¸…ç†æœªä½¿ç”¨çš„é•œåƒ..."
        docker image prune -af --filter "until=24h" || true
        
        echo ""
        echo "=== éƒ¨ç½²å®Œæˆ ==="
        echo "æ—¶é—´: $(date)"
        DEPLOY_SCRIPT
        
        chmod +x /tmp/deploy_final.sh
        echo "éƒ¨ç½²è„šæœ¬å‡†å¤‡å®Œæˆ"
    
    - name: Execute deployment
      env:
        VM_USER: ${{ secrets.VM_USER || 'ubuntu' }}
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        GHCR_TOKEN: ${{ secrets.CR_PAT }}
        GITHUB_USERNAME: ${{ github.repository_owner }}
        DEPLOY_TAG: ${{ env.DEPLOY_TAG }}
        IMAGE_FULL: ${{ env.IMAGE_FULL }}
        SHORT_SHA: ${{ env.SHORT_SHA }}
        REPO_OWNER: ${{ github.repository_owner }}
        REPO_NAME: ${{ github.event.repository.name }}
      run: |
        echo "ğŸš€ å¼€å§‹æ‰§è¡Œéƒ¨ç½²..."
        echo "ä»“åº“: $REPO_OWNER/$REPO_NAME"
        echo "çŸ­SHA: $SHORT_SHA"
        echo "éƒ¨ç½²æ ‡ç­¾: $DEPLOY_TAG"
        
        # ä¸Šä¼ éƒ¨ç½²è„šæœ¬
        sshpass -p "$VM_PASSWORD" scp \
          -o StrictHostKeyChecking=no \
          /tmp/deploy_final.sh $VM_USER@$VM_HOST:/tmp/deploy_final.sh
        
        # æ‰§è¡Œéƒ¨ç½²
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          $VM_USER@$VM_HOST << 'EOF'
        export GHCR_TOKEN='$GHCR_TOKEN'
        export GITHUB_USERNAME='$GITHUB_USERNAME'
        export DEPLOY_TAG='$DEPLOY_TAG'
        export IMAGE_FULL='$IMAGE_FULL'
        export SHORT_SHA='$SHORT_SHA'
        export REPO_OWNER='$REPO_OWNER'
        export REPO_NAME='$REPO_NAME'
        bash /tmp/deploy_final.sh
        EOF
        
        DEPLOY_EXIT=$?
        
        if [ $DEPLOY_EXIT -eq 0 ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆ"
            echo ""
            echo "åº”ç”¨ç°åœ¨è¿è¡Œåœ¨: http://$VM_HOST"
        else
            echo "âŒ éƒ¨ç½²å¤±è´¥"
            exit 1
        fi
  
  notification:
    name: Send Notification
    needs: [test, build, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Send success notification
      if: success()
      run: |
        echo "âœ… CI/CD Pipeline completed successfully!"
        echo "Deployment URL: http://${{ secrets.VM_HOST }}"
    
    - name: Send failure notification
      if: failure()
      run: |
        echo "âŒ CI/CD Pipeline failed!"
        echo "Check GitHub Actions logs for details."