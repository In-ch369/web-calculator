name: Web Calculator Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install sshpass
      run: |
        sudo apt-get update
        sudo apt-get install -y sshpass
    
    - name: Debug - Show secrets (部分)
      run: |
        echo "VM_USER: ${{ secrets.VM_USER }}"
        echo "VM_HOST: ${{ secrets.VM_HOST }}"
        echo "VM_PASSWORD 长度: ${#{{ secrets.VM_PASSWORD }}} 字符"
    
    - name: Test SSH with password
      env:
        VM_USER: ${{ secrets.VM_USER }}
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
      run: |
        echo "测试SSH连接到 $VM_USER@$VM_HOST..."
        
        # 方法1：使用sshpass直接测试
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          -o ConnectTimeout=10 \
          -v \
          "$VM_USER@$VM_HOST" \
          "echo '✅ SSH连接成功！'; whoami; pwd"
        
        if [ $? -eq 0 ]; then
          echo "✅ SSH密码认证成功"
        else
          echo "❌ SSH密码认证失败"
          echo "可能原因："
          echo "1. 密码错误"
          echo "2. 用户名错误"
          echo "3. 服务器限制了登录"
          exit 1
        fi
    
    - name: Build Docker image
      run: |
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        IMAGE_NAME="ghcr.io/${{ github.repository }}:sha-$SHORT_SHA"
        echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV
        
        # 构建镜像
        docker build -t $IMAGE_NAME .
        
        # 登录并推送
        echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
        docker push $IMAGE_NAME
    
    - name: Deploy to Server
      env:
        VM_USER: ${{ secrets.VM_USER }}
        VM_HOST: ${{ secrets.VM_HOST }}
        VM_PASSWORD: ${{ secrets.VM_PASSWORD }}
        IMAGE_NAME: ${{ env.IMAGE_NAME }}
      run: |
        echo "部署镜像: $IMAGE_NAME 到 $VM_USER@$VM_HOST"
        
        # 直接执行部署命令
        sshpass -p "$VM_PASSWORD" ssh \
          -o StrictHostKeyChecking=no \
          "$VM_USER@$VM_HOST" << 'DEPLOY_EOF'
        set -e
        
        echo "开始部署..."
        
        # 登录到GitHub Container Registry
        echo '${{ secrets.CR_PAT }}' | docker login ghcr.io -u '${{ github.actor }}' --password-stdin
        
        # 拉取镜像
        echo "拉取镜像: $IMAGE_NAME"
        docker pull "$IMAGE_NAME"
        
        # 重启容器
        echo "重启容器..."
        docker stop web-calculator 2>/dev/null || true
        docker rm web-calculator 2>/dev/null || true
        
        docker run -d \
          --name web-calculator \
          -p 5000:5000 \
          --restart always \
          "$IMAGE_NAME"
        
        echo "✅ 部署成功！"
        echo "容器状态:"
        docker ps | grep web-calculator
        
        # 等待并验证
        sleep 3
        echo "应用日志:"
        docker logs --tail 5 web-calculator
        DEPLOY_EOF